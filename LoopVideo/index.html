<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>YouTube 自動ループ再生</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  overflow-x: hidden;
}

body {
  font-family: sans-serif;
  padding: 16px;
  box-sizing: border-box;
}

*, *::before, *::after {
  box-sizing: border-box;
}

.video {
  display: none;
  margin-bottom: 24px;
}

/* ===== スライダー ===== */
.slider-area {
  position: relative;
  height: 64px;
  margin-top: 12px;
}

.range-bar {
  position: absolute;
  top: 23px;
  height: 4px;
  background: #1e88e5;
  border-radius: 2px;
  box-shadow: 0 0 6px #1e88e5;
}

.slider-area input[type=range] {
  position: absolute;
  top: 16px;
  width: 100%;
  pointer-events: none;
  background: none;
  -webkit-appearance: none;
}

.slider-area input[type=range]::-webkit-slider-runnable-track {
  height: 4px;
  background: transparent;
}

.slider-area input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none;
  pointer-events: auto;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: #fff;
  border: 2px solid #1e88e5;
  margin-top: -5px;
}

.time-label {
  position: absolute;
  top: 40px;
  font-size: 12px;
  transform: translateX(-50%);
  white-space: nowrap;
}
</style>
</head>

<body>

<h2>YouTube自動ループ再生</h2>

<div id="player-area"></div>

<hr>

<h3>動画URL</h3>
<div id="inputs">
  <input placeholder="YouTube URL 1"><br>
  <input placeholder="YouTube URL 2"><br>
  <input placeholder="YouTube URL 3"><br>
  <input placeholder="YouTube URL 4"><br>
  <input placeholder="YouTube URL 5"><br>
  <button onclick="loadVideos()">読み込み</button>
</div>

<hr>

<h3>タイマー</h3>
<input id="hour" type="number" min="0" placeholder="h"> 時間
<input id="min" type="number" min="0" placeholder="m"> 分
<br>
<label>
  <input id="stopAfter" type="checkbox">
  指定時間後に自動停止
</label>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
let players = [];
let blocks = [];
let ranges = [];
let current = 0;
let timerId = null;
const STORAGE_KEY = "yt_loop_urls";

/* 秒 → hh:mm:ss */
function fmt(t) {
  const h = String(Math.floor(t/3600)).padStart(2,"0");
  const m = String(Math.floor(t%3600/60)).padStart(2,"0");
  const s = String(Math.floor(t%60)).padStart(2,"0");
  return `${h}:${m}:${s}`;
}

/* URL → ID（youtu.be対応） */
function extractID(url) {
  try {
    const u = new URL(url);
    if (u.hostname === "youtu.be") return u.pathname.slice(1);
    if (u.searchParams.get("v")) return u.searchParams.get("v");
  } catch {}
  return null;
}

/* 保存 */
function saveURLs() {
  const v = [...document.querySelectorAll("#inputs input")].map(i => i.value);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(v));
}

/* 復元 */
function restoreURLs() {
  const s = localStorage.getItem(STORAGE_KEY);
  if (!s) return;
  JSON.parse(s).forEach((v,i)=>{
    document.querySelectorAll("#inputs input")[i].value = v || "";
  });
}

document.addEventListener("input", e=>{
  if(e.target.closest("#inputs")) saveURLs();
});

/* 読み込み */
function loadVideos() {
  saveURLs();
  document.getElementById("player-area").innerHTML="";
  players=[]; blocks=[]; ranges=[];
  current=0;

  const urls=[...document.querySelectorAll("#inputs input")]
    .map(i=>i.value).filter(Boolean);

  urls.forEach((url,i)=>{
    const id=extractID(url);
    if(!id) return;

    const block=document.createElement("div");
    block.className="video";

    const pdiv=document.createElement("div");
    const area=document.createElement("div");
    area.className="slider-area";

    const bar=document.createElement("div");
    bar.className="range-bar";

    const s=document.createElement("input");
    s.type="range";
    const e=document.createElement("input");
    e.type="range";

    const sl=document.createElement("div");
    sl.className="time-label";
    const el=document.createElement("div");
    el.className="time-label";

    area.append(bar,s,e,sl,el);
    block.append(pdiv,area);
    player-area.appendChild(block);

    blocks[i]=block;
    ranges[i]=[0,0];

    players[i]=new YT.Player(pdiv,{
      videoId:id,
      playerVars:{playsinline:1},
      events:{
        onReady:ev=>{
          const d=Math.floor(ev.target.getDuration());
          s.max=e.max=d;
          e.value=d;
          ranges[i]=[0,d];
          ui();
          if(i===0) play();
        },
        onStateChange:ev=>{
          if(ev.data===0) next();
          if(ev.data===1) loop();
        }
      }
    });

    function ui(){
      const[a,b]=ranges[i];
      const w=area.clientWidth;
      bar.style.left=a/e.max*w+"px";
      bar.style.width=(b-a)/e.max*w+"px";
      sl.textContent=fmt(a);
      el.textContent=fmt(b);
      sl.style.left=a/e.max*w+"px";
      el.style.left=b/e.max*w+"px";
    }

    s.oninput=()=>{if(+s.value>+e.value)s.value=e.value;ranges[i][0]=+s.value;ui();}
    e.oninput=()=>{if(+e.value<+s.value)e.value=s.value;ranges[i][1]=+e.value;ui();}
  });

  startTimer();
}

function play(){
  blocks.forEach((b,i)=>b.style.display=i===current?"block":"none");
  players[current].seekTo(ranges[current][0],true);
  players[current].playVideo();
}

function next(){
  current=(current+1)%players.length;
  play();
}

function loop(){
  const p=players[current];
  if(p.getCurrentTime()>=ranges[current][1]){
    p.seekTo(ranges[current][0],true);
  }
  requestAnimationFrame(loop);
}

/* タイマー */
function startTimer(){
  if(timerId) clearTimeout(timerId);
  const h=+hour.value||0;
  const m=+min.value||0;
  const t=(h*3600+m*60)*1000;
  if(t<=0) return;

  timerId=setTimeout(()=>{
    new Audio("https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg").play();
    if(stopAfter.checked){
      players[current]?.stopVideo();
    }
  },t);
}

window.addEventListener("load",restoreURLs);
</script>

</body>
</html>
