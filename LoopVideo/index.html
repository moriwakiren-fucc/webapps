<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>YouTube 自動ループ再生</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  overflow-x: hidden;
}

body {
  font-family: sans-serif;
  padding: 16px;
  box-sizing: border-box;
}

*, *::before, *::after {
  box-sizing: border-box;
}

.video {
  display: none;
  margin-bottom: 24px;
}

/* ===== スライダー ===== */
.slider-area {
  position: relative;
  height: 64px;
  margin-top: 12px;
}

.range-bar {
  position: absolute;
  top: 23px;
  height: 4px;
  background: #1e88e5;
  border-radius: 2px;
  box-shadow: 0 0 6px #1e88e5;
}

.slider-area input[type=range] {
  position: absolute;
  top: 16px;
  width: 100%;
  pointer-events: none;
  background: none;
  -webkit-appearance: none;
}

.slider-area input[type=range]::-webkit-slider-runnable-track {
  height: 4px;
  background: transparent;
}

.slider-area input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none;
  pointer-events: auto;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: #fff;
  border: 2px solid #1e88e5;
  margin-top: -5px;
}

.time-label {
  position: absolute;
  top: 40px;
  font-size: 12px;
  transform: translateX(-50%);
  white-space: nowrap;
}
</style>
</head>

<body>

<h2>YouTube自動ループ再生</h2>

<div id="player-area"></div>

<hr>

<h3>動画URL</h3>
<div id="inputs">
  <input placeholder="YouTube URL 1"><br>
  <input placeholder="YouTube URL 2"><br>
  <input placeholder="YouTube URL 3"><br>
  <input placeholder="YouTube URL 4"><br>
  <input placeholder="YouTube URL 5"><br>
  <button onclick="loadVideos()">読み込み</button>
</div>

<hr>

<h3>タイマー</h3>
<input id="hour" type="number" min="0" placeholder="h"> 時間
<input id="minute" type="number" min="0" placeholder="m"> 分
<br>
<label>
  <input id="stopAfter" type="checkbox">
  指定時間経過後に自動で再生を止める
</label>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
let players = [];
let blocks = [];
let ranges = [];
let current = 0;
let timerId = null;

/* 秒 → hh:mm:ss */
function format(t) {
  const h = String(Math.floor(t / 3600)).padStart(2, "0");
  const m = String(Math.floor((t % 3600) / 60)).padStart(2, "0");
  const s = String(Math.floor(t % 60)).padStart(2, "0");
  return `${h}:${m}:${s}`;
}

/* URL → 動画ID（youtu.be対応） */
function extractID(url) {
  try {
    const u = new URL(url);
    if (u.hostname === "youtu.be") return u.pathname.slice(1);
    if (u.searchParams.get("v")) return u.searchParams.get("v");
  } catch {}
  return null;
}

function loadVideos() {
  const root = document.getElementById("player-area");
  root.innerHTML = "";
  players = [];
  blocks = [];
  ranges = [];
  current = 0;

  const urls = [...document.querySelectorAll("#inputs input")]
    .map(i => i.value)
    .filter(Boolean);

  urls.forEach((url, i) => {
    const id = extractID(url);
    if (!id) return;

    const block = document.createElement("div");
    block.className = "video";

    const playerDiv = document.createElement("div");
    const area = document.createElement("div");
    area.className = "slider-area";

    const bar = document.createElement("div");
    bar.className = "range-bar";

    const start = document.createElement("input");
    start.type = "range";

    const end = document.createElement("input");
    end.type = "range";

    const sl = document.createElement("div");
    sl.className = "time-label";

    const el = document.createElement("div");
    el.className = "time-label";

    area.append(bar, start, end, sl, el);
    block.append(playerDiv, area);
    root.appendChild(block);

    blocks[i] = block;
    ranges[i] = [0, 0];

    players[i] = new YT.Player(playerDiv, {
      videoId: id,
      playerVars: { playsinline: 1 },
      events: {
        onReady: e => {
          const d = Math.floor(e.target.getDuration());
          start.max = end.max = d;
          end.value = d;
          ranges[i] = [0, d];
          updateUI();
          if (i === 0) playCurrent();
        },
        onStateChange: e => {
          if (i === current && e.data === 1) loop();
        }
      }
    });

    function updateUI() {
      const [a, b] = ranges[i];
      const w = area.clientWidth;
      bar.style.left = (a / end.max * w) + "px";
      bar.style.width = ((b - a) / end.max * w) + "px";
      sl.textContent = format(a);
      el.textContent = format(b);
      sl.style.left = (a / end.max * w) + "px";
      el.style.left = (b / end.max * w) + "px";
    }

    start.oninput = () => {
      if (+start.value > +end.value) start.value = end.value;
      ranges[i][0] = +start.value;
      updateUI();
    };

    end.oninput = () => {
      if (+end.value < +start.value) end.value = start.value;
      ranges[i][1] = +end.value;
      updateUI();
    };
  });

  startTimer();
}

function playCurrent() {
  blocks.forEach((b, i) => b.style.display = i === current ? "block" : "none");
  players[current].seekTo(ranges[current][0], true);
  players[current].playVideo();
}

function loop() {
  const p = players[current];
  if (p.getCurrentTime() >= ranges[current][1]) {
    p.seekTo(ranges[current][0], true);
  }
  requestAnimationFrame(loop);
}

/* ===== タイマー ===== */
function startTimer() {
  if (timerId) clearTimeout(timerId);

  const h = Number(document.getElementById("hour").value || 0);
  const m = Number(document.getElementById("minute").value || 0);
  const ms = (h * 3600 + m * 60) * 1000;

  if (ms <= 0) return;

  timerId = setTimeout(() => {
    new Audio(
      "https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"
    ).play();

    if (document.getElementById("stopAfter").checked) {
      players[current]?.stopVideo();
    }
  }, ms);
}
</script>

</body>
</html>
